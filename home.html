{{ header }} {{ content_fluid }} {% if (aurus_banners_fluid != 1) %}
<h1 class="ee-main-title">
  Энергосберегающие антивандальные светильники для ЖКХ
</h1>
<div class="ee-hero-row">
  <div class="ee-hero-left">{{ content_slleft }}</div>
  <div class="ee-hero-right">
    {# === EE landing: форма === #}
    <div class="ee-landing-form-wrapper">
      <form
        id="ee-lead-form"
        action="index.php?route=information/contact|send"
        method="post"
        class="ee-landing mb-4"
      >
        <p class="ee-landing-subtitle text-start">
          Получите коммерческое предложение по самым<br />
          выгодным ценам, оставив заявку на сайте:
        </p>
        <div class="row">
          <div class="col-xs-12 col-sm-6">
            <input
              type="text"
              name="name"
              class="form-control"
              placeholder="Ваше имя"
              required
            />
          </div>
          <div class="col-xs-12 col-sm-6">
            <input
              type="tel"
              name="telephone"
              class="form-control"
              placeholder="Телефон"
              required
            />
          </div>
        </div>
        <div class="row">
          <div class="col-xs-12">
            <input
              type="email"
              name="email"
              class="form-control"
              placeholder="Email"
              required
            />
          </div>
        </div>
        <input
          type="hidden"
          name="enquiry"
          value="Заявка с лендинга (Экран 1)"
        />
        <button
          type="submit"
          class="btn btn-success btn-lg btn-block"
          id="heroSubmitBtn"
        >
          Получить предложение
        </button>
      </form>
    </div>
    {# === /EE landing === #}
  </div>
</div>
{% endif %}

<div class="container">
  <div class="row">
    {{ column_left }} {% if (column_left and column_right) %} {% set class =
    'col-sm-5 col-md-6' %} {% elseif (column_left or column_right) %} {% set
    class = 'fix_cleft col-sm-9' %} {% else %} {% set class = 'col-sm-12' %} {%
    endif %} {% if (aurus_banners_fluid == 1) %} {% if (column_left or
    column_right) %} {% if (content_top1 or content_top2) %}
    <h1 class="ee-main-title">
      Энергосберегающие антивандальные светильники для ЖКХ
    </h1>
    <div class="ee-hero-row">
      <div class="ee-hero-left">{{ content_slleft }}</div>
      <div class="ee-hero-right">
        {# === EE landing: форма === #}
        <div class="ee-landing-form-wrapper">
          <form
            id="ee-lead-form"
            action="index.php?route=information/contact|send"
            method="post"
            class="ee-landing mb-4"
          >
            <p class="ee-landing-subtitle text-start">
              Получите коммерческое предложение по самым<br />
              выгодным ценам, оставив заявку на сайте:
            </p>
            <div class="row">
              <div class="col-xs-12 col-sm-6">
                <input
                  type="text"
                  name="name"
                  class="form-control"
                  placeholder="Ваше имя"
                  required
                />
              </div>
              <div class="col-xs-12 col-sm-6">
                <input
                  type="tel"
                  name="telephone"
                  class="form-control"
                  placeholder="Телефон"
                  required
                />
              </div>
            </div>
            <div class="row">
              <div class="col-xs-12">
                <input
                  type="email"
                  name="email"
                  class="form-control"
                  placeholder="Email"
                  required
                />
              </div>
            </div>
            <input
              type="hidden"
              name="enquiry"
              value="Заявка с лендинга (Экран 1)"
            />
            <button
              type="submit"
              class="btn btn-success btn-lg btn-block"
              id="heroSubmitBtn"
            >
              Получить предложение
            </button>
          </form>
        </div>
        {# === /EE landing === #}
      </div>
    </div>
    {% else %}
    <div class="ban_col sm_bann hcol-xs-12 col-sm-9 fixsl">
      {{ content_slleft }}
    </div>
    {% endif %} {% else %}
    <h1 class="ee-main-title">
      Энергосберегающие антивандальные светильники для ЖКХ
    </h1>
    <div class="ee-hero-row">
      <div class="ee-hero-left">{{ content_slleft }}</div>
      <div class="ee-hero-right">
        {# === EE landing: форма === #}
        <div class="ee-landing-form-wrapper">
          <form
            id="ee-lead-form"
            action="index.php?route=information/contact|send"
            method="post"
            class="ee-landing mb-4"
          >
            <p class="ee-landing-subtitle text-start">
              Получите коммерческое предложение по самым<br />
              выгодным ценам, оставив заявку на сайте:
            </p>
            <div class="row">
              <div class="col-xs-12 col-sm-6">
                <input
                  type="text"
                  name="name"
                  class="form-control"
                  placeholder="Ваше имя"
                  required
                />
              </div>
              <div class="col-xs-12 col-sm-6">
                <input
                  type="tel"
                  name="telephone"
                  class="form-control"
                  placeholder="Телефон"
                  required
                />
              </div>
            </div>
            <div class="row">
              <div class="col-xs-12">
                <input
                  type="email"
                  name="email"
                  class="form-control"
                  placeholder="Email"
                  required
                />
              </div>
            </div>
            <input
              type="hidden"
              name="enquiry"
              value="Заявка с лендинга (Экран 1)"
            />
            <button
              type="submit"
              class="btn btn-success btn-lg btn-block"
              id="heroSubmitBtn"
            >
              Получить предложение
            </button>
          </form>
        </div>
        {# === /EE landing === #}
      </div>
    </div>
    {% endif %} {% endif %}

    <div class="clearfix visible-xs"></div>

    <div id="content" class="{{ class }}">
      {{ content_top }} {% if (aurus_banners == 1) %}
      <div class="row flbann">
        {% if (content_bot2) %}
        <div
          class="{% if (aurus_banners_hiddensm == 1) %} hidden-xs {% endif %} containerfluid2 fluid2 col-xs-12 col-sm-12 col-md-12 col-lg-6 col-lg-push-3"
        >
          {{ content_bot2 }}
        </div>
        {% endif %} {% if (content_bot1) %}
        <div
          class="{% if (aurus_banners_hiddensm == 1) %} hidden-xs {% endif %} containerfluid2 fluid2 col-xs-6 col-sm-6 col-md-6 col-lg-3 col-lg-pull-6"
        >
          {{ content_bot1 }}
        </div>
        {% endif %} {% if (content_bot3) %}
        <div
          class="{% if (aurus_banners_hiddensm == 1) %} hidden-xs {% endif %} containerfluid2 fluid2 col-xs-6 col-sm-6 col-md-6 col-lg-3"
        >
          {{ content_bot3 }}
        </div>
        {% endif %}
      </div>
      {% endif %} {% if (content_slrig2) %} {{ content_slrig2 }} {% endif %}
    </div>

    {{ column_right }}
  </div>
</div>

{% if (content_slrig1) %}
<div class="containerfluid1">
  <div class="container">{{ content_slrig1 }}</div>
</div>
{% endif %} {% if (content_bottom) %}
<div class="container">
  <div class="row">
    <div id="content2" class="col-sm-12">{{ content_bottom }}</div>
  </div>
</div>
{% endif %} {% if (aurus_banners != 1) %}
<div class="container">
  <div class="row flbann containerfluid1">
    {% if (content_bot2) %}
    <div
      class="{% if (aurus_banners_hiddensm == 1) %} hidden-xs {% endif %} containerfluid2 col-xs-12 col-sm-12 col-md-6 col-lg-6 col-lg-push-3"
    >
      {{ content_bot2 }}
    </div>
    {% endif %} {% if (content_bot1) %}
    <div
      class="{% if (aurus_banners_hiddensm == 1) %} hidden-xs {% endif %} containerfluid2 col-xs-6 col-sm-6 col-md-3 col-lg-3 col-lg-pull-6"
    >
      {{ content_bot1 }}
    </div>
    {% endif %} {% if (content_bot3) %}
    <div
      class="{% if (aurus_banners_hiddensm == 1) %} hidden-xs {% endif %} containerfluid2 col-xs-6 col-sm-6 col-md-3 col-lg-3"
    >
      {{ content_bot3 }}
    </div>
    {% endif %}
  </div>
</div>
{% endif %}

<script>
  (function () {
    // ===== CONFIG (edit if you ever change things) =====
    var BTN_SEL = "#heroSubmitBtn";
    var FALLBACK_FORM_SEL = "#ee-lead-form";
    var HIDDEN_PRODUCT_ID = 164; // your numeric product_id (keep as a NUMBER)
    var COUNTRY_ID = 176; // Russia
    var ZONE_ID = 2726; // Moscow (any valid RU zone id works)
    var PAYMENT_CODE = "bank_transfer";

    if (typeof HIDDEN_PRODUCT_ID !== "number") {
      alert("Нужно указать числовой product_id скрытого товара.");
      return;
    }
    if (!window.jQuery) {
      return;
    }
    var $ = window.jQuery,
      running = false;

    // --- tiny helpers ---
    function jx(o) {
      return new Promise(function (res, rej) {
        $.ajax(
          $.extend(
            true,
            { headers: { "X-Requested-With": "XMLHttpRequest" } },
            o
          )
        )
          .done(function (data, ts, jq) {
            res({ data: data, jq: jq });
          })
          .fail(function (jq, ts, err) {
            rej({ jq: jq, err: err });
          });
      });
    }
    function POST(u, d) {
      return jx({ url: u, method: "POST", data: d });
    }
    function GET(u) {
      return jx({ url: u, method: "GET" });
    }
    function cartLooksNonEmpty(html) {
      return /cart|subtotal|итог|товар/i.test(String(html || ""));
    }
    function responseHasCartRedirect(r) {
      var s = String(r && r.data != null ? r.data : "");
      return (
        /route=checkout\/cart/.test(s) ||
        /location\s*=\s*['"][^'"]*route=checkout\/cart/.test(s)
      );
    }
    function setStatus(msg, color) {
      var n = document.getElementById("ee-lead-status");
      if (!n) {
        n = document.createElement("div");
        n.id = "ee-lead-status";
        n.style.marginTop = "8px";
        var f = getForm();
        if (f) f.appendChild(n);
      }
      n.textContent = msg;
      if (color) n.style.color = color;
    }
    function getForm() {
      var btn = document.querySelector(BTN_SEL);
      if (btn && btn.form) return btn.form;
      return (
        document.querySelector(FALLBACK_FORM_SEL) ||
        (btn ? btn.closest("form") : null) ||
        document.querySelector("form")
      );
    }

    // --- core steps (quiet, with self-heal) ---
    function ensureCart() {
      return POST("index.php?route=checkout/cart/add", {
        product_id: HIDDEN_PRODUCT_ID,
        quantity: 1,
      })
        .then(function () {
          return GET("index.php?route=checkout/cart");
        })
        .then(function (r) {
          if (!cartLooksNonEmpty(r.data))
            throw new Error("Товар не добавлен в корзину.");
        });
    }
    function initCheckout() {
      return GET("index.php?route=checkout/checkout");
    }

    function saveGuest(firstname, email, tel) {
      var payload = {
        firstname: firstname,
        lastname: "Клиент",
        email: email,
        telephone: tel,
        company: "",
        customer_group_id: 1,
        address_1: "Заявка с лендинга",
        address_2: "",
        city: "Москва",
        postcode: "",
        country_id: COUNTRY_ID,
        zone_id: ZONE_ID,
        shipping_address: 1,
      };
      return POST("index.php?route=checkout/guest/save", payload).then(
        function (r) {
          // if theme sent us to cart and cleared it → re-add item
          if (r.data && r.data.redirect) {
            return GET(r.data.redirect).then(function (rr) {
              if (!cartLooksNonEmpty(rr.data)) return ensureCart();
            });
          }
        }
      );
    }

    function paymentList() {
      return GET("index.php?route=checkout/payment_method").then(function (r) {
        var html = String(r.data || "");
        var tmp = document.createElement("div");
        tmp.innerHTML = html;
        var radios = tmp.querySelectorAll('input[name="payment_method"]');
        var codes = [];
        for (var i = 0; i < radios.length; i++) codes.push(radios[i].value);
        return codes;
      });
    }

    function savePaymentOrHeal(comment) {
      return paymentList().then(function (codes) {
        if (!codes.length)
          throw new Error("Нет способов оплаты для текущей корзины/адреса.");
        var code = codes.indexOf(PAYMENT_CODE) >= 0 ? PAYMENT_CODE : codes[0];
        return POST("index.php?route=checkout/payment_method/save", {
          payment_method: code,
          comment: comment,
          agree: 1,
        }).then(function (r) {
          if (r.data && r.data.error)
            throw new Error("Ошибка сохранения оплаты.");
          if (r.data && r.data.redirect) {
            // cart lost → heal and retry once
            return GET(r.data.redirect).then(function (rr) {
              if (!cartLooksNonEmpty(rr.data)) {
                return ensureCart().then(function () {
                  return savePaymentOrHeal(comment);
                });
              }
            });
          }
          return code;
        });
      });
    }

    function confirmSummaryOrHeal(comment) {
      return POST("index.php?route=checkout/confirm", {}).then(function (r) {
        if (responseHasCartRedirect(r)) {
          return ensureCart()
            .then(function () {
              return savePaymentOrHeal(comment);
            })
            .then(function () {
              return POST("index.php?route=checkout/confirm", {});
            });
        }
        return r;
      });
    }

    function paymentConfirm(code) {
      return POST(
        "index.php?route=extension/payment/" + code + "/confirm",
        {}
      ).catch(function () {
        return POST("index.php?route=payment/" + code + "/confirm", {});
      });
    }

    // --- bind: intercept native contact submit ---
    function bind() {
      var btn = document.querySelector(BTN_SEL);
      var form = getForm();
      if (!btn || !form) return;

      try {
        btn.type = "button";
      } catch (e) {}
      form.addEventListener(
        "submit",
        function (e) {
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();
          return false;
        },
        true
      );

      btn.addEventListener(
        "click",
        function (e) {
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();
          if (running) return;
          running = true;

          var nameEl = form.querySelector('input[name="name"]');
          var telEl = form.querySelector('input[name="telephone"]');
          var emailEl = form.querySelector('input[name="email"]');
          [nameEl, telEl, emailEl].forEach(function (el) {
            if (el) el.classList.remove("is-invalid");
          });
          if (!nameEl || !nameEl.value.trim()) {
            if (nameEl) nameEl.classList.add("is-invalid");
            running = false;
            return;
          }
          if (!telEl || !telEl.value.trim()) {
            if (telEl) telEl.classList.add("is-invalid");
            running = false;
            return;
          }
          if (
            !emailEl ||
            !emailEl.value ||
            !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailEl.value)
          ) {
            if (emailEl) emailEl.classList.add("is-invalid");
            running = false;
            return;
          }

          var firstname = nameEl.value.trim().slice(0, 32);
          var comment =
            "запрос на КП из контактной формы\n" +
            "Имя: " +
            firstname +
            "\n" +
            "Телефон: " +
            telEl.value.trim() +
            "\n" +
            "Email: " +
            emailEl.value.trim();

          setStatus("Создаём заявку...", "#666");

          ensureCart()
            .then(initCheckout)
            .then(function () {
              return saveGuest(
                firstname,
                emailEl.value.trim(),
                telEl.value.trim()
              );
            })
            .then(function () {
              return savePaymentOrHeal(comment);
            })
            .then(function (code) {
              return confirmSummaryOrHeal(comment).then(function () {
                return code;
              });
            })
            .then(paymentConfirm)
            .then(function () {
              setStatus(
                "Заявка оформлена! Мы скоро свяжемся с вами.",
                "#1a9f29"
              );
              try {
                form.reset();
              } catch (e) {}
            })
            .catch(function () {
              setStatus(
                "Не удалось оформить заказ. Проверьте поля и попробуйте ещё раз.",
                "#e11919"
              );
            })
            .finally(function () {
              running = false;
            });
        },
        true
      );
    }

    if (document.readyState === "loading")
      document.addEventListener("DOMContentLoaded", bind);
    else bind();
  })();
</script>

{{ footer }}

<style>
  /* === EE Landing: Основные стили === */
  .ee-main-title {
    color: #222222;
    font-size: 2.5rem;
    font-weight: 700;
    text-align: center;
    margin: 2rem 0 3rem;
    line-height: 1.2;
  }

  @media (max-width: 768px) {
    .ee-main-title {
      font-size: 2rem;
      margin: 1.5rem 0 2rem;
    }
  }

  @media (max-width: 576px) {
    .ee-main-title {
      font-size: 1.75rem;
      margin: 1rem 0 1.5rem;
    }
  }

  .ee-landing .btn-success {
    background: #1a9f29;
    border-color: #178e24;
  }
  .ee-landing .btn-success:hover {
    background: #178e24;
    border-color: #147a1f;
  }

  .ee-landing .ee-landing-subtitle {
    color: #222;
    font-size: 20px;
    font-weight: 700;
    margin: 0 0 14px;
    line-height: 1.25;
  }

  .ee-landing .form-control {
    height: 44px;
    padding: 10px 12px;
    font-size: 16px;
    border-radius: 8px;
    margin-bottom: 12px;
  }

  .ee-landing .form-control.is-invalid {
    border-color: #e11919;
    box-shadow: 0 0 0 0.2rem rgba(225, 25, 25, 0.25);
  }

  .ee-landing .btn-lg {
    height: 48px;
    border-radius: 8px;
    font-size: 18px;
    font-weight: 700;
  }

  .ee-landing .row + .row {
    margin-top: 12px;
  }

  .ee-landing-form-wrapper {
    padding: 22px 22px 18px;
    background: #fff;
    border-radius: 12px;
  }

  /* === Layout для hero секции === */
  .ee-hero-row {
    display: block;
  }

  @media (min-width: 992px) {
    .ee-hero-row {
      display: flex;
      align-items: stretch;
      gap: 20px;
    }

    .ee-hero-left,
    .ee-hero-right {
      flex: 1 1 0;
      min-width: 0;
    }

    .ee-hero-right .ee-landing-form-wrapper {
      margin-left: 18px;
    }
  }

  /* === Layout для banfluid колонок === */
  @media (min-width: 992px) {
    .banfluid {
      float: none;
      clear: none;
      display: inline-block;
      vertical-align: top;
    }

    .banfluid.col-md-9 {
      width: 58.3333%;
    }

    .banfluid.ee-form-col {
      width: 41.6667%;
    }

    .banfluid.col-md-3:not(.ee-form-col) {
      display: none;
    }

    .banfluid.ee-form-col .ee-landing-form-wrapper {
      margin-left: 18px;
    }

    .fixsl {
      width: 58.3333%;
    }

    .fixsn_ban.ee-form-col,
    .fixsn_ban2.ee-form-col {
      width: 41.6667%;
    }

    .fixsn_ban:not(.ee-form-col),
    .fixsn_ban2:not(.ee-form-col) {
      display: none;
    }
  }

  /* === Дополнительные стили === */
  .row.ee-gap > [class*="col-"] {
    margin-bottom: 10px;
  }

  .ee-hero-right .ee-landing-form-wrapper {
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }
</style>
